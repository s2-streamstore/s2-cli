name: CI
permissions:
  contents: read
'on':
  pull_request: null
  push:
    branches:
      - main
env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CLICOLOR: 1
  CARGO_INCREMENTAL: 0
concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true
jobs:
  ci:
    permissions:
      contents: none
    name: CI
    needs: lint
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Failed
        run: exit 1
        if: >-
          contains(needs.*.result, 'failure') || contains(needs.*.result,
          'cancelled') || contains(needs.*.result, 'skipped')
  lint:
    name: clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: 'clippy, rustfmt'
          toolchain: stable
      - name: Check format
        run: cargo +nightly fmt --all -- --check
      - name: Check clippy
        run: >-
          cargo clippy --workspace --all-features --all-targets -- -D warnings
          --allow deprecated
